<html>
  <body>
    This page contains javascript that can be included in an iframe and
    upon recieving commands over jschannel will attempt to invoke privileged
    repository management APIs.
  </body>
  <!-- jschannel, that's how our parent will control us -->
  <script src="../urlmatch.js"></script> 
  <script src="../jshelper.js"></script>
  <!-- finally, define our handlers that'll be invoked over jschannel by the parent -->
  <script>
   window.addEventListener('message', doSomething);
   var installed = false;
   function doSomething(event) {
     info(event.data);
     if(event.data == "getSelf") {
       var origin = URLParse(appURL).normalize().originOnly().toString();
       mozAppscb(navigator.mozApps.getSelf(),
           [{ status: "== \"success\"",
             installOrigin: "== " + "chrome://mochitests".quote(),
             origin: "== " + origin.quote(),
             manifestURL: "== " +  appURL.quote()
           }],
           next);
      }
      else if(event.data == "uninstall") {
        var pending = navigator.mozApps.getSelf();
        pending.onsuccess = function ()  {
          var result = pending.result.uninstall();
          result.onsuccess = function()  {
            ok(true, "app has been uninstalled by the domain");
            next();
          };
          result.onerror = function() {
            ok(false, "app uninstall failed");
            next();
          };
        };
        pending.onerror = function() {
          ok(false, "app uninstall failed through getSelf");
          next();
        };
      }
      else if(event.data == "install") {
        install(appURL,next);
        installed = true;
      }
      else if(event.data == "getInstalled") {
        if(installed == true) {
          getInstalled([appURL], next); 
        }
        mozAppscb(navigator.mozApps.getInstalled(),
            [{ status: "== \"success\""}],
            next);
      } 
      else if(event.data == "mgmt.getAll") {
        var hostname = window.location.hostname;
        info(hostname);
        if (hostname != "http://example.com") {
          mozAppscb(navigator.mozApps.mgmt.getAll(),
            [{ status: "== \"error\"",
               name: "== \"DENIED\""
            }], next);
        } else {
          mozAppscb(navigator.mozApps.mgmt.getAll(),
            [{ status: "== \"success\""}], next);            
        }

        
      }
   }
  </script>
</html>
